# 简介
哨兵巡查监控后台master主机是否故障，如果故障了根据<span style="color:rgb(255, 0, 0)">投票数</span>自动将某一个从库转换为新的主库，继续对外服务

哨兵的作用：
1. 监控redis的运行状态，包括slave和master
2. 当master挂了，自动将slave切换为master


功能：
1. 主从监控
2. 消息通知：哨兵可以将故障转移的结果发送给客户端
3. 故障转移：如果master故障，则会自动进行主从切换
4. 配置中心：客户端通过连接哨兵来获取当前redis服务的主节点地址

# 案例演示
## 架构说明
* 一主二从：用于数据读取和存放
* 三个哨兵：自动监控和维护集群，不存放数据
![[Pasted image 20240708152047.png]]

为什么要配三个哨兵：
* 一个挂了不影响
* 奇数好投票
* 哨兵也要配集群，保证高可用

## 操作
在用户定义的目录下创建`sentinel.conf`文件，<span style="color:rgb(255, 0, 0)">名字绝对不能出错</span> 

在redis的安装包里面也带了默认的`sentinel.conf`文件，可以先看看它是怎么写的

### 参数说明
redis自带的`sentinel.conf`文件中部分参数说明
* bind：服务监听地址，用于客户端连接，默认是本机地址
* daemonize：是否以守护进程的方式运行
* protected-mode：安全保护模式
* port：端口
* logfile：日志文件路径
* pidfile：pid文件路径
* dir：工作目录

#### 重要参数
```
sentinel monitor <master-name> <ip> <redis-port> <quorum>
```
设置要监控的master主机
quorum：表示最少几个哨兵认可客观下线，统一故障迁移的法定票数
![[Pasted image 20240708154013.png]]

因为网络是不可靠的，有时候sentinel会因为网络问题误以为一个master节点已经挂掉了。在sentinel集群中，需要多个sentinel互相沟通来确认这个master节点是不是真的挂了，quornum就是进行客观下线的参数。意思是至少有<span style="color:rgb(255, 0, 0)">quorum个sentinel认为这个master存在问题</span>，才会对这个master进行下线和故障转移。这样就<span style="color:rgb(255, 0, 0)">避免了单个sentinel因为网络问题而将正常master错误下线</span> 

```
sentinel auth-pass <master-name> <password>
```
![[Pasted image 20240708154410.png]]
master设置了密码，连接master服务的密码
![[Pasted image 20240708154543.png]]

改完之后大概内容就是这样：
![[Pasted image 20240708160451.png]]

### 启动哨兵
哨兵默认的端口和redis存储服务不同，默认为26379，<span style="color:rgb(255, 0, 0)">哨兵的端口也要不一样</span>
![[Pasted image 20240708160207.png]]
![[Pasted image 20240708160244.png]]

```shell
redis-sentinel /path/to/sentinel.conf
```
来启动集群
```
redis-server /path/to/sentinel.config --sentinel
```
也行

哨兵的设置不需要管slave的，master会告诉sentinel有关slave的信息。多个sentinel也是通过master了解其他sentinel的存在，并且将slave和其他sentinel的信息重新写入`sentinel.conf`



### 下线处理
当master下线后，sentinel将会进行投票将master客观下线，同时选举新的master

旧的master下线到新的master被投票选出需要一定的时间来切换，这时候原来的slave将会断开连接，也会报错`broken pipe`
![[Pasted image 20240708162253.png]]
这是因为旧的master下线

如果旧的master上线，也会被降级为slave，不会影响新的master

如果旧的maste<span style="color:rgb(255, 0, 0)">r没有在配置文件中写</span>`masterauth`，也就是密码，会报`auth`有关错误。<span style="color:rgb(255, 0, 0)">旧的master是不需要配置</span>`replicaof`，也就是master的有关信息的，`sentinel`会在配置文件中自动为我们加入

同时原来的slave的`replicaof`的信息也会被`sentinel`自动注释，也就是zhu'shi'diao'le